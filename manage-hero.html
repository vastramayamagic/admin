<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hero Section Manager - Vastramaya</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --header-height-desktop: 70px;
            --sidebar-width: 260px;
            --page-bg: #f4f5f7;
            --text-color: rgb(24, 24, 26);
            --icon-color: #6b7280;
            --icon-active: #5127ba;
            --active-bg: #f3f4f6;
            --hover-bg: #f3f4f6;
            --border-subtle: #e5e7eb;
            --brand-primary: #5127ba;
            --brand-gradient: linear-gradient(135deg, #5127ba 0%, #673de6 100%);
            --danger-color: #ef4444;
            --success-color: #10B981;
            --switch-on: #5127ba;
            --switch-off: #9CA3AF;
            --shadow-premium: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { min-height: 100vh; background: var(--page-bg); font-family: "DM Sans", sans-serif; font-size: 14px; color: var(--text-color); overflow-x: hidden; }

        /* LAYOUT */
        .page-desktop { display: flex; flex-direction: column; min-height: 100vh; }
        .d-topbar { height: var(--header-height-desktop); background: white; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; padding-left: 40px; position: fixed; top: 0; width: 100%; z-index: 100; }
        .d-topbar-logo { height: 52px; width: auto; }
        .d-app { display: flex; margin-top: var(--header-height-desktop); height: calc(100vh - var(--header-height-desktop)); }
        .d-sidebar { width: var(--sidebar-width); background: white; border-right: 1px solid var(--border-subtle); height: 100%; overflow-y: auto; position: fixed; }
        .d-content { margin-left: var(--sidebar-width); flex: 1; padding: 24px; overflow-y: auto; }
        
        /* NAV */
        .d-nav-item { display: flex; align-items: center; gap: 12px; padding: 12px; margin: 4px 12px; border-radius: 8px; cursor: pointer; color: var(--text-color); font-weight: 500; }
        .d-nav-item:hover { background: var(--hover-bg); }
        .d-nav-item--active { background: var(--active-bg); color: var(--brand-primary); }
        .d-nav-item--active svg { stroke: var(--icon-active); }
        .d-submenu { margin-left: 28px; padding-left: 12px; border-left: 1px solid var(--border-subtle); }
        .d-submenu-item { padding: 10px 12px; display: flex; gap: 10px; align-items: center; cursor: pointer; border-radius: 6px; font-weight: 500; }
        .d-submenu-item:hover { background: var(--hover-bg); }
        .d-submenu-item.active { background: var(--active-bg); color: var(--brand-primary); }

        /* HERO MANAGER CARD */
        .hero-manager-card { background: white; border-radius: 12px; border: 1px solid var(--border-subtle); padding: 32px; box-shadow: var(--shadow-premium); }
        .toggle-container { display: flex; justify-content: space-between; align-items: center; background: #f9fafb; padding: 20px; border-radius: 12px; border: 1px solid var(--border-subtle); margin-bottom: 30px; }
        .toggle-switch { width: 52px; height: 28px; background: var(--switch-off); border-radius: 20px; position: relative; cursor: pointer; transition: 0.3s; }
        .toggle-switch.active { background: var(--switch-on); }
        .toggle-switch::after { content: ''; position: absolute; width: 24px; height: 24px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: 0.3s; }
        .toggle-switch.active::after { transform: translateX(24px); }

        /* SLIDER CARDS */
        .slider-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .slider-card { background: #f9fafb; border: 1px solid var(--border-subtle); border-radius: 12px; overflow: hidden; cursor: pointer; transition: 0.2s; position: relative; }
        .slider-card:hover { border-color: var(--brand-primary); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .slider-card.active { border: 2px solid var(--brand-primary); }
        .slider-image-container { height: 160px; width: 100%; position: relative; }
        .slider-image { width: 100%; height: 100%; object-fit: cover; }
        .slider-content { padding: 16px; }
        .slider-badge { position: absolute; top: 10px; right: 10px; background: var(--brand-primary); color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        
        .add-slider-btn { height: 100%; min-height: 250px; border: 2px dashed #e5e7eb; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; color: #6b7280; gap: 10px; }
        .add-slider-btn:hover { border-color: var(--brand-primary); color: var(--brand-primary); background: #f9fafb; }

        /* FORMS */
        .form-section { background: #f9fafb; padding: 24px; border-radius: 12px; border: 1px solid var(--border-subtle); margin-top: 24px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-control { width: 100%; padding: 10px; border: 1px solid var(--border-subtle); border-radius: 8px; }
        
        /* IMAGE UPLOAD */
        .image-upload-wrapper { display: flex; gap: 16px; margin-bottom: 16px; }
        .upload-column { flex: 1; }
        .image-upload-zone { border: 2px dashed #e5e7eb; padding: 20px; text-align: center; border-radius: 12px; cursor: pointer; position: relative; min-height: 140px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .image-upload-zone:hover { border-color: var(--brand-primary); background: #f9fafb; }
        .image-preview-container { width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; }
        .image-preview-container.active { display: flex; }
        .image-preview { width: 100%; height: 100px; object-fit: contain; border-radius: 4px; margin-bottom: 8px; }
        .upload-label { font-size: 12px; color: #6b7280; margin-bottom: 4px; font-weight: 600; }

        /* BUTTONS */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-size: 14px; }
        .btn-primary { background: var(--brand-gradient); color: white; }
        .btn-secondary { background: white; border: 1px solid var(--border-subtle); color: var(--text-color); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-danger { background: #fef2f2; color: var(--danger-color); border: 1px solid #fecaca; }

        /* MODAL */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 90%; max-width: 700px; border-radius: 12px; display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header { padding: 16px 24px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 18px; }
        .modal-body { padding: 24px; overflow-y: auto; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border-subtle); display: flex; justify-content: flex-end; gap: 12px; }

        /* TOAST */
        #toast { position: fixed; bottom: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; }
        .toast-msg { background: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-left: 4px solid var(--success-color); animation: slideIn 0.3s ease; }
        .toast-msg.error { border-left-color: var(--danger-color); }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* MOBILE */
        @media (max-width: 768px) {
            .page-desktop { display: none; }
            .page-mobile { display: block; }
            .m-header { height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; background: white; border-bottom: 1px solid var(--border-subtle); position: fixed; top: 0; width: 100%; z-index: 50; }
            .m-main { margin-top: 70px; padding: 16px; padding-bottom: 100px; }
            .form-grid, .image-upload-wrapper { flex-direction: column; gap: 16px; }
            
            /* Mobile Drawer */
            .m-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; display: none; }
            .m-overlay.open { display: block; }
            .m-drawer { position: fixed; top: 0; left: 0; bottom: 0; width: 280px; background: white; transform: translateX(-100%); transition: 0.3s; z-index: 101; }
            .m-overlay.open .m-drawer { transform: translateX(0); }
        }
        @media (min-width: 769px) { .page-mobile { display: none; } }
    </style>
</head>
<body>

    <!-- ================= DESKTOP VIEW ================= -->
    <div class="page-desktop">
        <aside class="d-sidebar">
            <div style="padding: 20px;">
                <img src="https://product-ecommerces.netlify.app/vastramaya.png" alt="Logo" style="height: 40px;">
            </div>
            <div style="padding: 0 12px;">
                <div class="d-nav-item" onclick="window.location.href='index.html'">Dashboard</div>
                <div class="d-nav-item" onclick="window.location.href='manage-products.html'">Inventory</div>
                <div class="d-nav-item d-nav-item--active">Customize Site</div>
                <div class="d-submenu">
                    <div class="d-submenu-item active">Hero Section</div>
                    <div class="d-submenu-item" onclick="window.location.href='sections-manager.html'">Sections</div>
                    <div class="d-submenu-item" onclick="window.location.href='popup-manager.html'">Popup Manager</div>
                </div>
            </div>
        </aside>

        <main class="d-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h1 style="font-size: 24px; font-weight: 700;">Hero Section Manager</h1>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" onclick="previewHeroSection()">Preview</button>
                    <button class="btn btn-primary" onclick="saveAllSettings()">Save Changes</button>
                </div>
            </div>

            <div class="hero-manager-card">
                <!-- Global Toggle -->
                <div class="toggle-container">
                    <div>
                        <div style="font-weight: 600; font-size: 16px;">Enable Hero Section</div>
                        <div style="color: #6b7280; font-size: 13px;">Show/Hide the hero section on your homepage</div>
                    </div>
                    <div class="toggle-switch" id="hero-toggle" onclick="toggleHeroSection()"></div>
                </div>

                <!-- Sliders -->
                <div style="margin-bottom: 32px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="font-size: 18px; font-weight: 600;">Hero Sliders</h3>
                        <span style="color:#6b7280" id="slide-count">0 slides</span>
                    </div>

                    <div class="slider-cards" id="slider-cards">
                        <!-- Populated via JS -->
                    </div>
                </div>

                <!-- General Settings -->
                <div class="form-section">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--brand-primary)" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                        <h4 style="font-size: 16px; font-weight: 600;">Slider Settings</h4>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Animation</label>
                            <select class="form-control" id="setting-animation" onchange="updateSettingsState()">
                                <option value="slide">Slide</option>
                                <option value="fade">Fade</option>
                                <option value="zoom">Zoom</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Autoplay Speed</label>
                            <select class="form-control" id="setting-autoplay" onchange="updateSettingsState()">
                                <option value="3000">3 Seconds</option>
                                <option value="5000">5 Seconds</option>
                                <option value="7000">7 Seconds</option>
                                <option value="0">Disabled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Show Arrows</label>
                            <div class="toggle-switch active" id="setting-arrows" onclick="toggleSetting(this, 'showArrows')"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Show Dots</label>
                            <div class="toggle-switch active" id="setting-dots" onclick="toggleSetting(this, 'showDots')"></div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="resetSettings()">Reset to Defaults</button>
                    <button class="btn btn-primary" onclick="saveAllSettings()">Save Changes</button>
                </div>
            </div>
        </main>
    </div>

    <!-- ================= MOBILE VIEW ================= -->
    <div class="page-mobile">
        <header class="m-header">
            <div onclick="document.getElementById('m-overlay').classList.add('open')" style="padding: 10px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
            </div>
            <img src="https://product-ecommerces.netlify.app/vastramaya.png" alt="Logo" style="height: 32px;">
            <div style="width: 44px;"></div>
        </header>

        <div class="m-overlay" id="m-overlay" onclick="if(event.target===this) this.classList.remove('open')">
            <div class="m-drawer">
                <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between;">
                    <span style="font-weight: 700;">Menu</span>
                    <span onclick="document.getElementById('m-overlay').classList.remove('open')">✕</span>
                </div>
                <div style="padding: 10px;">
                    <div class="d-nav-item" onclick="window.location.href='index.html'">Dashboard</div>
                    <div class="d-nav-item" onclick="window.location.href='manage-products.html'">Inventory</div>
                    <div class="d-nav-item d-nav-item--active">Hero Section</div>
                </div>
            </div>
        </div>

        <main class="m-main">
            <div style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #e5e7eb; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <b>Enable Hero Section</b>
                    <div class="toggle-switch" id="mobile-hero-toggle" onclick="toggleMobileHeroSection()"></div>
                </div>
            </div>

            <div style="margin-bottom: 16px;">
                <h3 style="margin-bottom: 12px;">Slides</h3>
                <div id="mobile-slider-list" style="display: flex; flex-direction: column; gap: 12px;"></div>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 12px;" onclick="openAddSlideModal()">+ Add Slide</button>
            </div>

            <button class="btn btn-primary" style="width: 100%; position: fixed; bottom: 0; left: 0; border-radius: 0; padding: 15px; z-index: 90;" onclick="saveMobileHeroSettings()">Save Changes</button>
        </main>
    </div>

    <!-- ============= MODAL ============= -->
    <div class="modal-overlay" id="slide-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modal-title">Add Slide</span>
                <button class="btn btn-sm btn-secondary" onclick="closeSlideModal()">✕</button>
            </div>
            <div class="modal-body">
                <!-- Dual Image Upload -->
                <div class="image-upload-wrapper">
                    <!-- Desktop Image -->
                    <div class="upload-column">
                        <label class="upload-label">Desktop Image (1920x600)</label>
                        <div class="image-upload-zone" id="desktop-upload-zone" onclick="document.getElementById('desktop-img-input').click()">
                            <div class="upload-placeholder">Click to upload</div>
                            <div class="image-preview-container" id="desktop-preview-container">
                                <img id="desktop-preview" class="image-preview">
                                <button type="button" class="btn btn-sm btn-danger" onclick="event.stopPropagation(); removeImage('desktop')">✕</button>
                            </div>
                        </div>
                        <input type="file" id="desktop-img-input" style="display: none;" accept="image/*" onchange="handleImageUpload(this, 'desktop')">
                    </div>

                    <!-- Mobile Image -->
                    <div class="upload-column">
                        <label class="upload-label">Mobile Image (800x800)</label>
                        <div class="image-upload-zone" id="mobile-upload-zone" onclick="document.getElementById('mobile-img-input').click()">
                            <div class="upload-placeholder">Click to upload</div>
                            <div class="image-preview-container" id="mobile-preview-container">
                                <img id="mobile-preview" class="image-preview">
                                <button type="button" class="btn btn-sm btn-danger" onclick="event.stopPropagation(); removeImage('mobile')">✕</button>
                            </div>
                        </div>
                        <input type="file" id="mobile-img-input" style="display: none;" accept="image/*" onchange="handleImageUpload(this, 'mobile')">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-control" id="modal-slide-title" placeholder="Summer Collection">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-control" id="modal-slide-desc" placeholder="Up to 50% off">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Button Text</label>
                        <input type="text" class="form-control" id="modal-button-text" placeholder="Shop Now">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Button Link</label>
                        <input type="text" class="form-control" id="modal-button-link" placeholder="/shop">
                    </div>
                </div>
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <label class="form-label" style="margin: 0;">Active</label>
                        <div class="toggle-switch active" id="modal-slide-toggle" onclick="this.classList.toggle('active')"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: space-between;">
                <button class="btn btn-danger" id="delete-slide-btn" style="display: none;" onclick="deleteCurrentSlide()">Remove</button>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="closeSlideModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="confirmSaveSlide()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCdeonH3VytC21F3X6x0rCVCn2xXrGPoug",
            authDomain: "vastramaya---magic.firebaseapp.com",
            projectId: "vastramaya---magic",
            storageBucket: "vastramaya---magic.firebasestorage.app",
            messagingSenderId: "543460072082",
            appId: "1:543460072082:web:f3d1140e8f81ad338ae44b",
            measurementId: "G-E39VNDCFVE"
        };
        const ADMIN_EMAIL = "harshavardhanjw@gmail.com";

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // --- STATE ---
        let state = {
            enabled: true,
            settings: {
                animation: 'slide',
                autoplaySpeed: 5000,
                showArrows: true,
                showDots: true
            },
            slides: []
        };

        let currentEditingIndex = -1;
        let pendingDesktopFile = null;
        let pendingMobileFile = null;

        // --- AUTH & INIT ---
        auth.onAuthStateChanged(user => {
            if (user && user.email === ADMIN_EMAIL) {
                loadData();
            } else {
                window.location.href = 'index.html';
            }
        });

        // --- LOAD DATA ---
        async function loadData() {
            showToast('Loading settings...');
            try {
                const doc = await db.collection('landingPage').doc('HeroSections').get();
                if (doc.exists) {
                    const data = doc.data();
                    state = { ...state, ...data };
                }
                renderAll();
            } catch (error) {
                console.error("Load error:", error);
                showToast("Failed to load settings", true);
            }
        }

        // --- RENDERING ---
        function renderAll() {
            // Main Toggles
            const desktopToggle = document.getElementById('hero-toggle');
            const mobileToggle = document.getElementById('mobile-hero-toggle');
            
            if (state.enabled) {
                desktopToggle.classList.add('active');
                mobileToggle.classList.add('active');
            } else {
                desktopToggle.classList.remove('active');
                mobileToggle.classList.remove('active');
            }

            // Settings Inputs
            document.getElementById('setting-animation').value = state.settings.animation;
            document.getElementById('setting-autoplay').value = state.settings.autoplaySpeed;
            
            const arrowsToggle = document.getElementById('setting-arrows');
            state.settings.showArrows ? arrowsToggle.classList.add('active') : arrowsToggle.classList.remove('active');
            
            const dotsToggle = document.getElementById('setting-dots');
            state.settings.showDots ? dotsToggle.classList.add('active') : dotsToggle.classList.remove('active');

            // Render Slides
            document.getElementById('slide-count').innerText = `${state.slides.length} slides`;
            renderSlidesDesktop();
            renderSlidesMobile();
        }

        function renderSlidesDesktop() {
            const container = document.getElementById('slider-cards');
            // Keep the "Add New" button (last child logic logic handled by manual clearing)
            const addBtnHTML = `
                <div class="add-slider-btn" onclick="openAddSlideModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                    <div>Add New Slide</div>
                </div>`;
            
            container.innerHTML = state.slides.map((slide, index) => `
                <div class="slider-card ${slide.active ? 'active' : ''}" onclick="openSlideModal(${index})">
                    <div class="slider-image-container">
                        <img src="${slide.desktopImage || slide.image || 'https://via.placeholder.com/400x200?text=No+Image'}" class="slider-image">
                        ${slide.active ? '<div class="slider-badge">Active</div>' : ''}
                    </div>
                    <div class="slider-content">
                        <div class="slider-content-title">${slide.title}</div>
                        <div style="font-size:12px; color:#6b7280; margin-bottom:10px;">${slide.description}</div>
                        <div style="display:flex; justify-content:space-between;">
                            <span style="font-size:12px; background:${slide.active?'#d1fae5':'#f3f4f6'}; color:${slide.active?'#065f46':'#6b7280'}; padding:2px 6px; border-radius:4px;">${slide.active?'Active':'Inactive'}</span>
                            <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); toggleSlideStatus(${index})">${slide.active?'Disable':'Enable'}</button>
                        </div>
                    </div>
                </div>
            `).join('') + addBtnHTML;
        }

        function renderSlidesMobile() {
            const container = document.getElementById('mobile-slider-list');
            container.innerHTML = state.slides.map((slide, index) => `
                <div style="display:flex; align-items:center; gap:12px; padding:12px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px;">
                    <img src="${slide.mobileImage || slide.image || 'https://via.placeholder.com/100x100?text=No+Image'}" style="width:60px; height:40px; object-fit:cover; border-radius:4px;">
                    <div style="flex:1;">
                        <div style="font-weight:600; font-size:14px;">${slide.title}</div>
                        <div style="font-size:12px; color:${slide.active?'#10B981':'#9CA3AF'}">${slide.active?'Active':'Inactive'}</div>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="openSlideModal(${index})">Edit</button>
                </div>
            `).join('');
        }

        // --- INTERACTIONS & WRAPPERS ---
        function toggleHeroSection() {
            state.enabled = !state.enabled;
            renderAll();
        }
        function toggleMobileHeroSection() {
            toggleHeroSection();
        }

        function toggleSetting(element, key) {
            element.classList.toggle('active');
            state.settings[key] = element.classList.contains('active');
        }

        function updateSettingsState() {
            state.settings.animation = document.getElementById('setting-animation').value;
            state.settings.autoplaySpeed = document.getElementById('setting-autoplay').value;
        }

        function resetSettings() {
            if(confirm("Reset all slider settings to default?")) {
                state.settings = {
                    animation: 'slide',
                    autoplaySpeed: 5000,
                    showArrows: true,
                    showDots: true
                };
                renderAll();
                showToast("Settings reset to defaults");
            }
        }

        function openAddSlideModal() {
            openSlideModal(-1);
        }

        function toggleSlideStatus(index) {
            state.slides[index].active = !state.slides[index].active;
            state.slides[index].status = state.slides[index].active ? 'active' : 'inactive';
            renderAll();
        }

        // --- MODAL LOGIC ---
        function openSlideModal(index = -1) {
            currentEditingIndex = index;
            pendingDesktopFile = null;
            pendingMobileFile = null;
            
            // UI References
            const titleEl = document.getElementById('modal-title');
            const titleInput = document.getElementById('modal-slide-title');
            const descInput = document.getElementById('modal-slide-desc');
            const btnTextInput = document.getElementById('modal-button-text');
            const btnLinkInput = document.getElementById('modal-button-link');
            const toggle = document.getElementById('modal-slide-toggle');
            const deleteBtn = document.getElementById('delete-slide-btn');
            
            // Image Preview Elements
            const desktopPreview = document.getElementById('desktop-preview');
            const mobilePreview = document.getElementById('mobile-preview');
            const desktopContainer = document.getElementById('desktop-preview-container');
            const mobileContainer = document.getElementById('mobile-preview-container');
            const desktopPlaceholder = document.querySelector('#desktop-upload-zone .upload-placeholder');
            const mobilePlaceholder = document.querySelector('#mobile-upload-zone .upload-placeholder');

            if (index > -1) {
                // Edit Mode
                const slide = state.slides[index];
                titleEl.innerText = "Edit Slide";
                titleInput.value = slide.title;
                descInput.value = slide.description;
                btnTextInput.value = slide.buttonText || "";
                btnLinkInput.value = slide.buttonLink || "";
                
                if (slide.active) toggle.classList.add('active');
                else toggle.classList.remove('active');

                // Show Desktop Image
                if (slide.desktopImage || slide.image) {
                    desktopPreview.src = slide.desktopImage || slide.image;
                    desktopContainer.classList.add('active');
                    desktopPlaceholder.style.display = 'none';
                } else {
                    desktopContainer.classList.remove('active');
                    desktopPlaceholder.style.display = 'block';
                }

                // Show Mobile Image
                if (slide.mobileImage) {
                    mobilePreview.src = slide.mobileImage;
                    mobileContainer.classList.add('active');
                    mobilePlaceholder.style.display = 'none';
                } else {
                    mobileContainer.classList.remove('active');
                    mobilePlaceholder.style.display = 'block';
                }
                
                deleteBtn.style.display = 'block';
            } else {
                // Add Mode
                titleEl.innerText = "Add New Slide";
                titleInput.value = "";
                descInput.value = "";
                btnTextInput.value = "";
                btnLinkInput.value = "";
                toggle.classList.add('active');

                // Reset images
                desktopContainer.classList.remove('active');
                desktopPlaceholder.style.display = 'block';
                mobileContainer.classList.remove('active');
                mobilePlaceholder.style.display = 'block';
                desktopPreview.src = "";
                mobilePreview.src = "";
                
                deleteBtn.style.display = 'none';
            }

            document.getElementById('slide-modal').style.display = 'flex';
        }

        function closeSlideModal() {
            document.getElementById('slide-modal').style.display = 'none';
        }

        function toggleModalSlideStatus() {
            document.getElementById('modal-slide-toggle').classList.toggle('active');
        }

        function removeImage(type) {
            if (type === 'desktop') {
                pendingDesktopFile = null;
                document.getElementById('desktop-preview-container').classList.remove('active');
                document.querySelector('#desktop-upload-zone .upload-placeholder').style.display = 'block';
                document.getElementById('desktop-img-input').value = '';
                // If editing, you might want to clear the saved URL in state, handled in save
            } else {
                pendingMobileFile = null;
                document.getElementById('mobile-preview-container').classList.remove('active');
                document.querySelector('#mobile-upload-zone .upload-placeholder').style.display = 'block';
                document.getElementById('mobile-img-input').value = '';
            }
        }

        function handleImageUpload(input, type) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if(file.size > 5 * 1024 * 1024) {
                    showToast("Image too large (max 5MB)", true);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (type === 'desktop') {
                        pendingDesktopFile = file;
                        const container = document.getElementById('desktop-preview-container');
                        document.getElementById('desktop-preview').src = e.target.result;
                        container.classList.add('active');
                        document.querySelector('#desktop-upload-zone .upload-placeholder').style.display = 'none';
                    } else {
                        pendingMobileFile = file;
                        const container = document.getElementById('mobile-preview-container');
                        document.getElementById('mobile-preview').src = e.target.result;
                        container.classList.add('active');
                        document.querySelector('#mobile-upload-zone .upload-placeholder').style.display = 'none';
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        async function confirmSaveSlide() {
            const title = document.getElementById('modal-slide-title').value.trim();
            const isActive = document.getElementById('modal-slide-toggle').classList.contains('active');
            
            if (!title) return showToast("Title is required", true);

            const saveBtn = document.querySelector('.modal-footer .btn-primary');
            saveBtn.innerText = "Saving...";
            saveBtn.disabled = true;

            // Get existing URLs if editing
            let desktopUrl = currentEditingIndex > -1 ? (state.slides[currentEditingIndex].desktopImage || state.slides[currentEditingIndex].image) : '';
            let mobileUrl = currentEditingIndex > -1 ? state.slides[currentEditingIndex].mobileImage : '';

            try {
                // Upload Desktop Image
                if (pendingDesktopFile) {
                    const ref = storage.ref(`hero-slides/desktop/${Date.now()}_${pendingDesktopFile.name}`);
                    await ref.put(pendingDesktopFile);
                    desktopUrl = await ref.getDownloadURL();
                }

                // Upload Mobile Image
                if (pendingMobileFile) {
                    const ref = storage.ref(`hero-slides/mobile/${Date.now()}_${pendingMobileFile.name}`);
                    await ref.put(pendingMobileFile);
                    mobileUrl = await ref.getDownloadURL();
                }

                if (!desktopUrl && currentEditingIndex === -1) {
                    saveBtn.innerText = "Save";
                    saveBtn.disabled = false;
                    return showToast("Desktop image is required", true);
                }

                const slideData = {
                    id: currentEditingIndex > -1 ? state.slides[currentEditingIndex].id : Date.now(),
                    title: title,
                    description: document.getElementById('modal-slide-desc').value.trim(),
                    buttonText: document.getElementById('modal-button-text').value.trim(),
                    buttonLink: document.getElementById('modal-button-link').value.trim(),
                    desktopImage: desktopUrl,
                    mobileImage: mobileUrl || desktopUrl, // Fallback to desktop if mobile not provided
                    image: desktopUrl, // Backward compatibility
                    active: isActive,
                    status: isActive ? 'active' : 'inactive'
                };

                if (currentEditingIndex > -1) {
                    state.slides[currentEditingIndex] = slideData;
                } else {
                    state.slides.push(slideData);
                }

                closeSlideModal();
                renderAll();
                showToast("Slide updated locally. Click 'Save Changes' to finish.");
            } catch (e) {
                console.error(e);
                showToast("Image upload failed", true);
            } finally {
                saveBtn.innerText = "Save";
                saveBtn.disabled = false;
            }
        }

        function deleteCurrentSlide() {
            if (confirm("Are you sure you want to remove this slide?")) {
                if (currentEditingIndex > -1) {
                    state.slides.splice(currentEditingIndex, 1);
                    renderAll();
                    closeSlideModal();
                    showToast("Slide removed");
                }
            }
        }

        // --- SAVING ---
        async function saveAllSettings() {
            const btns = document.querySelectorAll('.page-desktop .btn-primary, .page-mobile .btn-primary'); 
            btns.forEach(b => {
                b.innerText = "Saving...";
                b.disabled = true;
            });

            updateSettingsState();

            try {
                await db.collection('landingPage').doc('HeroSections').set({
                    enabled: state.enabled,
                    settings: state.settings,
                    slides: state.slides,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                showToast("Hero section updated successfully!");
            } catch (error) {
                console.error("Save error:", error);
                showToast("Error saving changes", true);
            } finally {
                btns.forEach(b => {
                    b.innerText = "Save Changes";
                    b.disabled = false;
                });
            }
        }

        function saveMobileHeroSettings() {
            saveAllSettings().then(() => {
                document.getElementById('m-overlay').classList.remove('open');
            });
        }

        function previewHeroSection() {
            showToast("Opening preview...");
            // Simulate preview logic. In real app, this might open a new tab with ?preview=true
            setTimeout(() => {
                // Create a temporary overlay to show preview
                const previewHtml = `
                    <div style="position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:9999; display:flex; align-items:center; justify-content:center;" onclick="this.remove()">
                        <div style="background:white; width:90%; height:80%; border-radius:12px; overflow:hidden; position:relative;">
                            <div style="position:absolute; top:10px; right:10px; cursor:pointer; background:white; padding:5px 10px; border-radius:4px;">Close Preview</div>
                            <iframe src="https://vastramaya-magic.web.app" style="width:100%; height:100%; border:none;"></iframe>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', previewHtml);
            }, 500);
        }

        // --- UTILS ---
        function showToast(msg, isError = false) {
            const toast = document.createElement('div');
            toast.className = `toast-msg ${isError ? 'error' : ''}`;
            toast.innerText = msg;
            document.getElementById('toast').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
