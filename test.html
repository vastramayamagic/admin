<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Coupons - ShopSphere</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #4F46E5;
            --primary-hover: #4338CA;
        }
        ::-webkit-scrollbar { display: none; }
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; color: #1F2937; }
        
        .bg-brand { background-color: var(--primary-color); }
        .text-brand { color: var(--primary-color); }
        .border-brand { border-color: var(--primary-color); }

        @keyframes modalPop {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .animate-pop { animation: modalPop 0.25s ease-out forwards; }

        .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #D1D5DB; transition: .3s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(16px); }

        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 3000; }
        .toast { padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 10px; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        .custom-select-list { display: none; }
        .custom-select-list.show { display: block; animation: modalPop 0.2s ease; }
    </style>
</head>
<body class="py-6 px-4">
    <div id="toast-container"></div>

    <div class="max-w-6xl mx-auto">
        <!-- HEADER -->
        <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-10">
            <div>
                <p class="text-[11px] font-black text-brand uppercase tracking-[0.25em] mb-1">Store Management</p>
                <h1 class="text-4xl font-black text-gray-900 tracking-tight">Coupons</h1>
            </div>
            <button onclick="openModal()" class="bg-brand hover:bg-indigo-700 text-white px-6 py-4 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-all w-full md:w-auto">
                <i data-lucide="plus" class="w-5 h-5"></i> Create New Coupon
            </button>
        </div>

        <!-- FILTERS -->
        <div class="flex flex-row items-center gap-2 mb-8">
            <div class="relative flex-grow">
                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                <input type="text" id="search-bar" onkeyup="handleSearch()" placeholder="Search by code..." class="w-full bg-white border border-gray-200 rounded-xl py-3 pl-12 pr-4 text-sm font-medium focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>
        </div>

        <!-- TABLE -->
        <div class="hidden md:block">
            <table class="w-full border-separate border-spacing-y-3">
                <thead>
                    <tr class="text-left text-[10px] font-black uppercase tracking-widest text-gray-400">
                        <th class="pb-2 pl-6">Coupon Details</th>
                        <th class="pb-2">Discount</th>
                        <th class="pb-2">Usage / Limit</th>
                        <th class="pb-2">Status</th>
                        <th class="pb-2 pr-6 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody id="coupon-table-body">
                    <tr><td colspan="5" class="text-center py-10 text-gray-400">Loading coupons...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- MOBILE LIST -->
        <div id="mobile-coupon-list" class="grid grid-cols-1 gap-4 md:hidden"></div>
    </div>

    <!-- MODAL -->
    <div id="form-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg rounded-[2rem] p-8 shadow-2xl animate-pop relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeModal()" class="absolute top-6 right-6 p-2 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            
            <h2 id="form-title" class="text-2xl font-black mb-8 text-gray-900">Create Coupon</h2>
            
            <div class="space-y-5">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-1 mb-2 block">Coupon Code</label>
                    <input type="text" id="input-code" oninput="this.value = this.value.toUpperCase()" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-4 font-mono font-bold text-lg outline-none focus:border-indigo-500">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="relative">
                        <label class="text-[10px] font-bold text-gray-400 uppercase ml-1 mb-2 block">Type</label>
                        <button onclick="toggleDropdown('type-drop')" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-4 text-left font-bold flex justify-between items-center">
                            <span id="type-label">Percentage (%)</span>
                            <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400"></i>
                        </button>
                        <div id="type-drop" class="custom-select-list absolute w-full mt-2 bg-white border border-gray-100 rounded-xl shadow-2xl z-[110] py-1">
                            <div onclick="setDropValue('type-label', 'Percentage (%)', 'type-drop')" class="px-5 py-3 hover:bg-indigo-50 font-bold cursor-pointer">Percentage (%)</div>
                            <div onclick="setDropValue('type-label', 'Flat Amount (₹)', 'type-drop')" class="px-5 py-3 hover:bg-indigo-50 font-bold cursor-pointer">Flat Amount (₹)</div>
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase ml-1 mb-2 block">Value</label>
                        <input type="number" id="input-value" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-4 font-bold text-lg outline-none focus:border-indigo-500">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase ml-1 mb-2 block">Total Limit</label>
                        <input type="number" id="input-limit" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-4 font-bold outline-none focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase ml-1 mb-2 block">User Limit</label>
                        <input type="number" id="input-user-limit" value="1" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-4 font-bold outline-none focus:border-indigo-500">
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-1 mb-2 block">Expiry Date</label>
                    <input type="date" id="input-expiry" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-4 font-bold outline-none focus:border-indigo-500">
                </div>

                <button id="save-btn" onclick="saveCouponData()" class="w-full bg-brand hover:bg-indigo-700 text-white py-5 rounded-2xl font-bold shadow-xl mt-6 active:scale-95 transition-all">Save Coupon</button>
            </div>
        </div>
    </div>

    <!-- FIREBASE SDKS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCdeonH3VytC21F3X6x0rCVCn2xXrGPoug",
            authDomain: "vastramaya---magic.firebaseapp.com",
            projectId: "vastramaya---magic",
            storageBucket: "vastramaya---magic.firebasestorage.app",
            messagingSenderId: "543460072082",
            appId: "1:543460072082:web:f3d1140e8f81ad338ae44b"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const ADMIN_EMAIL = "harshavardhanjw@gmail.com";
        
        // Path requested: Coupon (coll) -> Coupon (doc) -> List (sub-coll)
        const couponRef = db.collection('Coupon').doc('Coupon').collection('List');

        let allCoupons = [];
        let editingId = null;
        let searchQuery = "";

        // Admin Security Check
        auth.onAuthStateChanged(user => {
            if (!user || user.email !== ADMIN_EMAIL) {
                alert("Access Denied: Admin only.");
                window.location.href = 'index.html';
            } else {
                fetchCoupons();
            }
        });

        async function fetchCoupons() {
            couponRef.onSnapshot(snapshot => {
                allCoupons = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            });
        }

        function renderUI() {
            const desktopBody = document.getElementById('coupon-table-body');
            const mobileList = document.getElementById('mobile-coupon-list');
            
            const filtered = allCoupons.filter(c => c.code.toLowerCase().includes(searchQuery.toLowerCase()));

            if (filtered.length === 0) {
                desktopBody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-gray-400 font-medium">No coupons found.</td></tr>`;
                mobileList.innerHTML = `<p class="text-center py-10 text-gray-400">No coupons found.</p>`;
                return;
            }

            desktopBody.innerHTML = filtered.map(c => `
                <tr class="bg-white border border-gray-100 rounded-2xl shadow-sm">
                    <td class="py-5 pl-6 rounded-l-2xl">
                        <div class="font-bold text-gray-900">${c.code}</div>
                        <div class="text-[9px] text-gray-400 font-bold uppercase">Exp: ${c.expiry || 'No Expiry'}</div>
                    </td>
                    <td class="py-5 font-bold text-brand">${c.type.includes('%') ? c.value + '%' : '₹' + c.value}</td>
                    <td class="py-5">
                        <div class="text-[10px] font-bold text-gray-600">Usage: ${c.used || 0} / ${c.limit}</div>
                        <div class="text-[9px] text-indigo-400 font-bold">User Limit: ${c.userLimit}</div>
                    </td>
                    <td class="py-5">
                        <label class="switch"><input type="checkbox" onchange="toggleStatus('${c.id}', ${c.active})" ${c.active ? 'checked' : ''}><span class="slider"></span></label>
                    </td>
                    <td class="py-5 pr-6 text-right rounded-r-2xl">
                        <div class="flex items-center justify-end gap-2">
                            <button onclick="editCoupon('${c.id}')" class="px-4 py-2 border border-brand text-brand hover:bg-indigo-50 rounded-lg text-xs font-bold transition-all">Edit</button>
                            <button onclick="deleteCoupon('${c.id}')" class="p-2 bg-red-50 text-red-500 rounded-lg hover:bg-red-100 transition-colors">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            mobileList.innerHTML = filtered.map(c => `
                <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm space-y-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-lg font-black text-gray-900 tracking-tight">${c.code}</div>
                            <div class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Expires: ${c.expiry || 'N/A'}</div>
                        </div>
                        <label class="switch"><input type="checkbox" onchange="toggleStatus('${c.id}', ${c.active})" ${c.active ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="flex justify-between items-center text-sm">
                        <span class="font-bold text-brand">${c.type.includes('%') ? c.value + '%' : '₹' + c.value}</span>
                        <span class="text-gray-400 text-xs font-bold">Limit: ${c.limit}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editCoupon('${c.id}')" class="flex-grow py-3 border border-brand text-brand font-bold rounded-xl text-xs">Edit</button>
                        <button onclick="deleteCoupon('${c.id}')" class="px-4 py-3 bg-red-50 text-red-500 rounded-xl"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function saveCouponData() {
            const btn = document.getElementById('save-btn');
            const data = {
                code: document.getElementById('input-code').value.toUpperCase(),
                type: document.getElementById('type-label').innerText,
                value: parseFloat(document.getElementById('input-value').value),
                limit: parseInt(document.getElementById('input-limit').value) || 100,
                userLimit: parseInt(document.getElementById('input-user-limit').value) || 1,
                expiry: document.getElementById('input-expiry').value,
                active: true,
                used: 0
            };

            if (!data.code || isNaN(data.value)) return showToast("Code and Value are required", "error");

            btn.disabled = true;
            btn.innerText = "Saving...";

            try {
                if (editingId) {
                    await couponRef.doc(editingId).update(data);
                    showToast("Coupon updated successfully!");
                } else {
                    await couponRef.add(data);
                    showToast("Coupon created successfully!");
                }
                closeModal();
            } catch (e) {
                showToast("Error saving coupon", "error");
            } finally {
                btn.disabled = false;
                btn.innerText = "Save Coupon";
            }
        }

        async function toggleStatus(id, currentStatus) {
            try {
                await couponRef.doc(id).update({ active: !currentStatus });
                showToast("Status updated");
            } catch (e) { showToast("Error updating status", "error"); }
        }

        async function deleteCoupon(id) {
            if (confirm("Delete this coupon permanently?")) {
                await couponRef.doc(id).delete();
                showToast("Coupon deleted", "success");
            }
        }

        function editCoupon(id) {
            const c = allCoupons.find(i => i.id === id);
            editingId = id;
            document.getElementById('form-title').innerText = "Edit Coupon";
            document.getElementById('input-code').value = c.code;
            document.getElementById('input-value').value = c.value;
            document.getElementById('input-limit').value = c.limit;
            document.getElementById('input-user-limit').value = c.userLimit;
            document.getElementById('input-expiry').value = c.expiry || '';
            document.getElementById('type-label').innerText = c.type;
            document.getElementById('form-modal').classList.remove('hidden');
        }

        function openModal() {
            editingId = null;
            document.getElementById('form-title').innerText = "Create Coupon";
            ['input-code', 'input-value', 'input-limit', 'input-user-limit', 'input-expiry'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('input-user-limit').value = 1;
            document.getElementById('form-modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('form-modal').classList.add('hidden'); }
        function handleSearch() { searchQuery = document.getElementById('search-bar').value; renderUI(); }
        function toggleDropdown(id) { document.getElementById(id).classList.toggle('show'); }
        function setDropValue(lId, v, dId) { document.getElementById(lId).innerText = v; toggleDropdown(dId); }

        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            toast.innerText = msg;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Close dropdowns on outside click
        window.onclick = (e) => {
            if (!e.target.closest('.relative') && !e.target.closest('button')) {
                document.querySelectorAll('.custom-select-list').forEach(d => d.classList.remove('show'));
            }
        }
    </script>
</body>
</html>
