<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Customize Site - Vastramaya</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        :root {
            --body-bg: #F8FAFC;
            --widget-bg: #FFFFFF;
            --border-color: #F1F5F9;
            --text-primary: #0F172A;
            --text-secondary: #64748B;
            --brand-primary: #3B82F6;
            --brand-gradient: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
            --hover-bg: #F8FAFC;
            --danger-color: #EF4444;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 24px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: var(--body-bg); color: var(--text-primary); font-size: 14px; line-height: 1.5; }
        a { text-decoration: none; color: inherit; }
        ul { list-style: none; }
        input, button, select, textarea { font-family: inherit; font-size: inherit; outline: none; }
        button:focus { outline: none; }

        /* --- DASHBOARD LAYOUT --- */
        .dashboard-container { display: grid; grid-template-columns: 280px 1fr; height: 100vh; position: relative; }
        .main-area { display: flex; flex-direction: column; overflow-y: auto; height: 100vh; background-color: var(--body-bg); }
        
        /* --- SIDEBAR (Desktop: 280px) --- */
        .sidebar { 
            background-color: var(--widget-bg); 
            border-right: 1px solid var(--border-color); 
            padding: 2rem 1.5rem; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            transition: transform 0.3s ease-in-out;
            box-shadow: var(--shadow-sm);
            z-index: 1001;
        }
        .sidebar-header { display: flex; align-items: center; margin-bottom: 2.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); } 
        .logo-container { display: flex; align-items: center; width: 100%; }
        .logo-image { height: 42px; width: auto; object-fit: contain; }
        
        .main-nav ul { list-style: none; display: flex; flex-direction: column; gap: 0.5rem; }
        .main-nav a { 
            display: flex; align-items: center; gap: 1rem; text-decoration: none; color: var(--text-secondary); 
            font-weight: 500; padding: 0.875rem 1rem; border-radius: var(--radius-md); transition: var(--transition); position: relative;
        }
        .main-nav a i { font-size: 1.4rem; color: var(--text-secondary); transition: var(--transition); width: 24px; text-align: center; }
        .main-nav a:hover { background-color: var(--hover-bg); color: var(--text-primary); transform: translateY(-1px); } 
        .main-nav a:hover i { color: var(--brand-primary); }
        .main-nav a.active { 
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%); 
            color: var(--brand-primary); font-weight: 600; box-shadow: var(--shadow-sm);
        } 
        .main-nav a.active i { color: var(--brand-primary); }
        .main-nav a.active::before {
            content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 4px; height: 60%; background: var(--brand-gradient); border-radius: 0 4px 4px 0;
        }
        
        /* --- PROFILE SECTION --- */
        .profile-section { 
            margin-top: auto; padding-top: 1.5rem; border-top: 1px solid var(--border-color); 
            display: flex; align-items: center; gap: 0.75rem; cursor: pointer; 
            border-radius: var(--radius-md); transition: var(--transition); padding: 1rem;
        }
        .profile-section:hover { background-color: var(--hover-bg); }
        .profile-content-wrapper { display: flex; align-items: center; gap: 0.75rem; width: 100%; }
        .profile-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 2px solid var(--border-color); transition: var(--transition); }
        .profile-section:hover .profile-avatar { border-color: var(--brand-primary); }
        .profile-details { flex-grow: 1; min-width: 0; }
        .profile-name { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; font-size: 0.9rem; }
        .profile-email { font-size: 0.8rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        .profile-options i { font-size: 1.25rem; color: var(--text-secondary); transition: var(--transition); }
        .profile-section.active .profile-options i { transform: rotate(180deg); }
        
        .profile-popup { 
            position: absolute; bottom: 90px; left: 1.5rem; right: 1.5rem; 
            background-color: var(--widget-bg); border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-lg); border: 1px solid var(--border-color); 
            padding: 0.75rem; z-index: 100; opacity: 0; pointer-events: none; 
            transform: translateY(10px) scale(0.95); transition: var(--transition); 
        }
        .profile-popup.active { opacity: 1; pointer-events: all; transform: translateY(0) scale(1); }
        .popup-header { display: flex; align-items: center; gap: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); margin-bottom: 0.5rem; }
        .popup-list { list-style: none; } 
        .popup-list a { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: var(--radius-sm); text-decoration: none; color: var(--text-primary); transition: var(--transition); cursor: pointer; }
        .popup-list a:hover { background-color: var(--hover-bg); } 
        .popup-list a i { font-size: 1.2rem; color: var(--text-secondary); }
        .popup-list a.logout i { color: var(--danger-color); } 
        .popup-list a.logout { color: var(--danger-color); }
        
        /* --- HEADER --- */
        .main-header { 
            padding: 12px 2.5rem; 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background-color: var(--widget-bg); 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            box-shadow: var(--shadow-sm); 
            min-height: 70px;
        }
        .nav-logo { height: 42px; width: auto; object-fit: contain; display: none; }
        .menu-toggle, .sidebar-close-btn { display: none; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 999; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .overlay.active { opacity: 1; pointer-events: auto; }

        /* --- PAGE CONTENT --- */
        .page-container { max-width: 1200px; margin: 0 auto; padding: 2rem; width: 100%; }
        .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; gap: 1rem; }
        .page-title { font-size: 1.75rem; font-weight: 700; color: var(--text-primary); margin: 0; }

        .form-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 2rem; }
        .form-col { display: flex; flex-direction: column; gap: 2rem; }
        
        .editor-card { background: var(--widget-bg); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); padding: 1.5rem; border: 1px solid var(--border-color); }
        .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 1.25rem; display: flex; align-items: center; justify-content: space-between; color: var(--text-primary); }
        
        .input-group { margin-bottom: 1.25rem; }
        .input-label { display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .form-control { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); background: #fff; transition: var(--transition); font-size: 0.95rem; }
        .form-control:focus { border-color: var(--brand-primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        
        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.6rem 1rem; font-weight: 600; border-radius: var(--radius-md); cursor: pointer; transition: var(--transition); border: none; font-size: 0.9rem; }
        .btn-primary { background: var(--brand-gradient); color: white; box-shadow: var(--shadow-md); }
        .btn-primary:hover { box-shadow: var(--shadow-lg); transform: translateY(-1px); }
        .btn-secondary { background: white; border: 1px solid var(--border-color); color: var(--text-primary); }
        .btn-secondary:hover { background: #F8FAFC; border-color: #CBD5E1; }
        .btn-icon { padding: 0.5rem; background: transparent; border: none; color: var(--text-secondary); cursor: pointer; border-radius: 6px; font-size: 1.2rem; }
        .btn-icon:hover { background: #F1F5F9; color: var(--text-primary); }

        .swatch-upload-container { width: 120px; height: 120px; border-radius: var(--radius-md); border: 2px dashed #CBD5E1; background: #F8FAFC; display: flex; align-items: center; justify-content: center; flex-direction: column; cursor: pointer; overflow: hidden; position: relative; }
        .swatch-upload-container img { width: 100%; height: 100%; object-fit: contain; padding: 5px; display: none; }
        
        .upload-box { width: 100%; border: 2px dashed #CBD5E1; border-radius: var(--radius-md); padding: 1.5rem; text-align: center; cursor: pointer; background: #F8FAFC; transition: 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 120px; }
        .upload-box:hover { border-color: var(--brand-primary); background: #EFF6FF; }
        .upload-box img { max-width: 100%; max-height: 150px; object-fit: contain; margin-bottom: 0.5rem; display: none; border-radius: 4px; }
        .upload-box.has-image img { display: block; }
        .upload-box.has-image .upload-placeholder { display: none; }

        /* List Items */
        .sortable-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .sortable-item { display: flex; align-items: center; justify-content: space-between; background: #fff; border: 1px solid var(--border-color); padding: 0.75rem 1rem; border-radius: var(--radius-md); }
        .sortable-item:hover { border-color: var(--brand-primary); }
        .item-content { display: flex; align-items: center; gap: 1rem; flex: 1; }
        .item-actions { display: flex; gap: 0.5rem; }
        
        .toggle-switch { appearance: none; width: 36px; height: 20px; background: #CBD5E1; border-radius: 20px; position: relative; cursor: pointer; transition: 0.3s; }
        .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background: white; border-radius: 50%; transition: 0.3s; }
        .toggle-switch:checked { background: var(--success-color); }
        .toggle-switch:checked::after { transform: translateX(16px); }

        .color-input-wrapper { display: flex; align-items: center; gap: 0.5rem; }
        .color-preview-box { width: 40px; height: 40px; border-radius: var(--radius-md); border: 1px solid var(--border-color); cursor: pointer; position: relative; overflow: hidden; }
        .color-preview-box input[type="color"] { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; cursor: pointer; opacity: 0; }
        
        .product-select-item { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; border-bottom: 1px solid #F1F5F9; cursor: pointer; transition: 0.2s; }
        .product-select-item:hover { background: #F8FAFC; }
        .product-select-info { display: flex; align-items: center; gap: 1rem; }
        .product-select-img { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; background: #eee; }
        
        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 1rem; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); display: flex; flex-direction: column; overflow: hidden; animation: modalPop 0.3s ease; max-height: 90vh; }
        @keyframes modalPop { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .modal-body { padding: 1.5rem; overflow-y: auto; background: #F8FAFC; flex: 1; }
        .modal-footer { padding: 1.25rem 1.5rem; background: white; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 1rem; }

        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 3000; pointer-events: none; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 1rem 1.5rem; background: white; border-radius: var(--radius-md); box-shadow: var(--shadow-lg); animation: slideUp 0.3s ease; display: flex; align-items: center; gap: 1rem; border-left: 4px solid var(--brand-primary); min-width: 300px; pointer-events: auto; }
        .toast.success { border-left-color: var(--success-color); }
        .toast.error { border-left-color: var(--danger-color); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 5000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #E2E8F0; border-top: 4px solid var(--brand-primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 1024px) {
            .dashboard-container { grid-template-columns: 1fr; }
            .sidebar { 
                position: fixed; top: 0; left: 0; height: 100%; width: 85%; max-width: 320px; 
                z-index: 1000; transform: translateX(-100%); box-shadow: var(--shadow-lg); 
                padding: 2rem 1.25rem;
            }
            .sidebar.active { transform: translateX(0); }
            .main-header { padding: 12px 1.5rem; justify-content: space-between; }
            
            /* Show logo in mobile menu */
            .sidebar .logo-container { display: flex; }
            
            /* Show logo in navbar on mobile */
            .nav-logo { display: block; height: 36px; }
            
            .menu-toggle { 
                display: flex; align-items: center; justify-content: center; width: 46px; height: 46px; 
                font-size: 1.6rem; color: var(--text-primary); cursor: pointer; 
                border: 1px solid var(--border-color); border-radius: var(--radius-md); background-color: white;
            }
            .sidebar-close-btn { 
                display: flex; align-items: center; justify-content: center; position: absolute; 
                top: 1.5rem; right: 1.25rem; font-size: 1.75rem; color: var(--text-secondary); 
                cursor: pointer; border: none; background: none; width: 36px; height: 36px;
            }
            
            .page-container { padding: 1rem; }
            .form-grid { grid-template-columns: 1fr; }
            
            /* Mobile Modal */
            .modal-overlay { align-items: flex-end; padding: 0; }
            .modal-content { 
                width: 100%; max-width: 100%; border-radius: var(--radius-xl) var(--radius-xl) 0 0 !important; 
                max-height: 85vh; animation: slideUpModal 0.3s cubic-bezier(0.16, 1, 0.3, 1); 
            }
            @keyframes slideUpModal { from { transform: translateY(100%); } to { transform: translateY(0); } }
        }
        @media (min-width: 1025px) { .nav-logo { display: none; } }
    </style>
</head>
<body>
    <div class="overlay" id="overlay"></div>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; font-weight: 500;">Saving Changes...</p>
    </div>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <button class="sidebar-close-btn" id="sidebar-close-btn"><i class='bx bx-x'></i></button>
            <div class="sidebar-header">
                <div class="logo-container">
                    <img src="https://www.vastramayamagic.in/vastramaya-logo.png" alt="Vastramaya Logo" class="logo-image">
                </div>
            </div>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html"><i class='bx bx-home-alt'></i> Dashboard</a></li>
                    <li><a href="manage-category.html"><i class='bx bx-package'></i> Inventory</a></li>
                    <li><a href="#" class="active"><i class='bx bx-palette'></i> Customize Site</a></li>
                    <li><a href="#"><i class='bx bx-clipboard'></i> All Orders</a></li>
                </ul>
            </nav>
            <div class="profile-section" id="profile-section">
                <div class="profile-content-wrapper">
                    <img id="sidebar-avatar" src="" class="profile-avatar">
                    <div class="profile-details">
                        <span class="profile-name" id="sidebar-name">Loading...</span>
                        <span class="profile-email" id="sidebar-email">Admin</span>
                    </div>
                    <div class="profile-options"><i class='bx bx-chevron-down'></i></div>
                </div>
            </div>
            <div class="profile-popup" id="profile-popup">
                <div class="popup-header">
                    <img id="popup-avatar" src="" class="profile-avatar">
                    <div class="profile-details">
                        <span class="profile-name" id="popup-name">Loading...</span>
                        <span class="profile-email" id="popup-email">Admin</span>
                    </div>
                </div>
                <ul class="popup-list">
                    <li><a href="#"><i class='bx bx-user'></i> Profile</a></li>
                    <li><a href="#"><i class='bx bx-cog'></i> Settings</a></li>
                    <li><a href="#" onclick="auth.signOut()" class="logout"><i class='bx bx-log-out'></i> Logout</a></li>
                </ul>
            </div>
        </aside>
        
        <main class="main-area">
            <header class="main-header">
                <button class="menu-toggle" id="menu-toggle"><i class='bx bx-menu'></i></button>
                <img src="https://www.vastramayamagic.in/vastramaya-logo.png" alt="Vastramaya Logo" class="nav-logo">
            </header>
            
            <div class="page-container">
                <div class="content-header">
                    <h1 class="page-title">Customize Site</h1>
                    <button class="btn btn-primary" onclick="saveAllChanges()">Save Changes</button>
                </div>

                <div class="form-grid">
                    <!-- Left Column -->
                    <div class="form-col">
                        <!-- Branding -->
                        <div class="editor-card">
                            <h3 class="section-title">Branding & Theme</h3>
                            <div class="input-group">
                                <label class="input-label">Store Name</label>
                                <input type="text" class="form-control" id="store-name" placeholder="Vastramaya">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Store Logo</label>
                                <div class="upload-box" id="logo-upload-box" onclick="document.getElementById('logo-upload').click()">
                                    <img id="logo-preview" src="">
                                    <div class="upload-placeholder">
                                        <i class='bx bx-image-add' style="font-size:2rem; color:#94A3B8;"></i>
                                        <div style="margin-top:0.5rem; font-size:0.9rem; color:#64748B;">Click to upload logo</div>
                                    </div>
                                </div>
                                <input type="file" id="logo-upload" accept="image/*" style="display:none;">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Primary Brand Color</label>
                                <div class="color-input-wrapper">
                                    <div class="color-preview-box" id="color-preview">
                                        <input type="color" id="primary-color" onchange="updateColor(this.value)">
                                    </div>
                                    <input type="text" class="form-control" id="color-hex" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation -->
                        <div class="editor-card">
                            <div class="section-title">
                                <span>Navigation Menu</span>
                                <button class="btn btn-secondary btn-sm" onclick="openLinkModal()">+ Add Link</button>
                            </div>
                            <div id="nav-list" class="sortable-list"></div>
                        </div>

                        <!-- Hero Section -->
                        <div class="editor-card">
                            <div class="section-title">
                                <span>Hero Carousel</span>
                                <button class="btn btn-secondary btn-sm" onclick="openHeroModal()">+ Add Image</button>
                            </div>
                            <div id="hero-list" class="sortable-list"></div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="form-col">
                        <!-- Featured Categories -->
                        <div class="editor-card">
                            <h3 class="section-title">Featured Categories (Circles)</h3>
                            <p style="font-size:0.85rem; color:var(--text-secondary); margin-bottom:1rem;">Select categories to show in the top circular scroll.</p>
                            <div id="featured-cats-list" style="display:grid; grid-template-columns: 1fr 1fr; gap:0.5rem;">
                                <!-- Checkboxes injected here -->
                            </div>
                        </div>

                        <!-- Category Sections (Rows) -->
                        <div class="editor-card">
                            <h3 class="section-title">Home Page Sections</h3>
                            <p style="font-size:0.85rem; color:var(--text-secondary); margin-bottom:1rem;">Reorder and toggle visibility of product rows.</p>
                            <div id="section-list" class="sortable-list"></div>
                        </div>

                        <!-- Promo Banner -->
                        <div class="editor-card">
                            <div class="section-title">
                                <span>Promo Banner</span>
                                <input type="checkbox" class="toggle-switch" id="promo-active">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Banner Text</label>
                                <input type="text" class="form-control" id="promo-text" placeholder="Free Shipping on Orders Over â‚¹999">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Link URL (Optional)</label>
                                <input type="text" class="form-control" id="promo-link" placeholder="/shop">
                            </div>
                        </div>
                        
                        <!-- Best Sellers -->
                        <div class="editor-card">
                            <div class="section-title">
                                <span>Best Sellers</span>
                                <button class="btn btn-secondary btn-sm" onclick="openBestSellerModal()">Select Products</button>
                            </div>
                            <p style="font-size:0.85rem; color:var(--text-secondary);">Select products to display in the Best Sellers grid.</p>
                            <div id="selected-bs-count" style="font-size:0.9rem; margin-top:0.5rem; color:var(--brand-primary); font-weight:500;">0 products selected</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Add Link Modal -->
    <div class="modal-overlay" id="link-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Menu Link</h3>
                <button class="btn-icon" onclick="closeModal('link-modal')"><i class='bx bx-x'></i></button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label class="input-label">Label Name</label>
                    <input type="text" class="form-control" id="link-label" placeholder="e.g. Men's Wear">
                </div>
                <div class="input-group">
                    <label class="input-label">Destination URL</label>
                    <input type="text" class="form-control" id="link-url" placeholder="/category/mens">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('link-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="addNavLink()">Add Link</button>
            </div>
        </div>
    </div>

    <!-- Hero Modal (Image Upload) -->
    <div class="modal-overlay" id="hero-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Hero Slide</h3>
                <button class="btn-icon" onclick="closeModal('hero-modal')"><i class='bx bx-x'></i></button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label class="input-label">Desktop Image</label>
                    <div class="upload-box" id="hero-desktop-box" onclick="document.getElementById('hero-desktop-file').click()">
                        <img id="hero-desktop-preview">
                        <div class="upload-placeholder">
                            <i class='bx bx-laptop' style="font-size:2rem; color:#94A3B8;"></i>
                            <div style="margin-top:0.5rem; font-size:0.9rem; color:#64748B;">Upload Desktop Banner</div>
                        </div>
                    </div>
                    <input type="file" id="hero-desktop-file" accept="image/*" style="display:none;">
                </div>
                <div class="input-group">
                    <label class="input-label">Mobile Image</label>
                    <div class="upload-box" id="hero-mobile-box" onclick="document.getElementById('hero-mobile-file').click()">
                        <img id="hero-mobile-preview">
                        <div class="upload-placeholder">
                            <i class='bx bx-mobile' style="font-size:2rem; color:#94A3B8;"></i>
                            <div style="margin-top:0.5rem; font-size:0.9rem; color:#64748B;">Upload Mobile Banner</div>
                        </div>
                    </div>
                    <input type="file" id="hero-mobile-file" accept="image/*" style="display:none;">
                </div>
                <div class="input-group">
                    <label class="input-label">Link (Optional)</label>
                    <input type="text" class="form-control" id="hero-link" placeholder="/shop">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('hero-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="addHeroImage()">Add Slide</button>
            </div>
        </div>
    </div>

    <!-- Best Sellers Modal -->
    <div class="modal-overlay" id="bestseller-modal">
        <div class="modal-content" style="max-height:80vh;">
            <div class="modal-header">
                <h3 class="modal-title">Select Best Sellers</h3>
                <button class="btn-icon" onclick="closeModal('bestseller-modal')"><i class='bx bx-x'></i></button>
            </div>
            <div class="modal-body" style="padding:0; display:flex; flex-direction:column;">
                <div style="padding:1rem; background:#fff; border-bottom:1px solid #F1F5F9; position:sticky; top:0; z-index:10;">
                    <input type="text" class="form-control" id="bs-search" placeholder="Search products...">
                </div>
                <div id="bs-list" style="flex:1; overflow-y:auto; display:flex; flex-direction:column;">
                    <div style="padding:2rem; text-align:center;">
                        <div class="spinner" style="width:30px; height:30px; margin:0 auto;"></div>
                        <p style="color:#64748B; margin-top:0.5rem;">Loading products...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('bestseller-modal')">Done</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <script>
        // --- Init & Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCdeonH3VytC21F3X6x0rCVCn2xXrGPoug",
            authDomain: "vastramaya---magic.firebaseapp.com",
            projectId: "vastramaya---magic",
            storageBucket: "vastramaya---magic.firebasestorage.app",
            messagingSenderId: "543460072082",
            appId: "1:543460072082:web:f3d1140e8f81ad338ae44b",
            measurementId: "G-E39VNDCFVE"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const ADMIN_EMAIL = "vastramayamagic@gmail.com";

        // --- State ---
        let branding = { name: 'Vastramaya', color: '#3B82F6', logo: '' };
        let navigation = [];
        let heroImages = [];
        let featuredCats = [];
        let categorySections = [];
        let allCategories = [];
        let allProducts = [];
        let bestSellersIds = [];
        let logoFile = null;
        
        // Temp files for Hero
        let tempHeroDesktop = null;
        let tempHeroMobile = null;

        // --- Auth ---
        auth.onAuthStateChanged(user => {
            if (!user || user.email !== ADMIN_EMAIL) {
                window.location.href = 'index.html';
                return;
            }
            initUI(user);
            loadAllData();
        });

        function initUI(user) {
            const name = user.displayName || 'Admin';
            const avatar = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=3B82F6&color=fff`;
            document.getElementById('sidebar-name').textContent = name;
            document.getElementById('sidebar-email').textContent = user.email;
            document.getElementById('sidebar-avatar').src = avatar;
            document.getElementById('popup-name').textContent = name;
            document.getElementById('popup-email').textContent = user.email;
            document.getElementById('popup-avatar').src = avatar;
            
            // Mobile Menu Logic
            const sidebar = document.getElementById('sidebar');
            const menuToggle = document.getElementById('menu-toggle');
            const closeBtn = document.getElementById('sidebar-close-btn');
            const overlay = document.getElementById('overlay');
            const profileSection = document.getElementById('profile-section');
            const profilePopup = document.getElementById('profile-popup');

            const toggleMenu = () => {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            };

            menuToggle.addEventListener('click', toggleMenu);
            closeBtn.addEventListener('click', toggleMenu);
            overlay.addEventListener('click', toggleMenu);

            profileSection.addEventListener('click', e => { 
                e.stopPropagation(); 
                profilePopup.classList.toggle('active'); 
            });
            document.addEventListener('click', e => { 
                if (!profileSection.contains(e.target)) profilePopup.classList.remove('active'); 
            });
        }

        // --- Data Loading ---
        async function loadAllData() {
            try {
                // 1. Fetch Categories & Products First
                const catsSnap = await db.collection('categories').orderBy('name').get();
                allCategories = catsSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                const prodSnap = await db.collection('products').get();
                allProducts = prodSnap.docs.map(d => {
                    const data = d.data();
                    return { 
                        id: d.id, 
                        name: data.name, 
                        category: data.category, 
                        image: (data.images && data.images.length) ? data.images[0] : null,
                        price: data.price
                    };
                });

                // 2. Fetch Landing Page Configs
                const [brandDoc, navDoc, featCatDoc, sectionsDoc, heroDoc, promoDoc, bestDoc] = await Promise.all([
                    db.collection('landingPage').doc('branding').get(),
                    db.collection('landingPage').doc('navigation').get(),
                    db.collection('landingPage').doc('featuredCategories').get(),
                    db.collection('landingPage').doc('categorySections').get(),
                    db.collection('landingPage').doc('heroImages').get(),
                    db.collection('landingPage').doc('promoBanner').get(),
                    db.collection('landingPage').doc('bestSellers').get()
                ]);

                // Branding
                if(brandDoc.exists) {
                    branding = brandDoc.data();
                    document.getElementById('store-name').value = branding.name;
                    updateColor(branding.color);
                    if(branding.logo) {
                        document.getElementById('logo-preview').src = branding.logo;
                        document.getElementById('logo-upload-box').classList.add('has-image');
                    }
                }

                // Navigation
                if(navDoc.exists) navigation = navDoc.data().links || [];
                renderNavigation();

                // Hero
                if(heroDoc.exists) heroImages = heroDoc.data().images || [];
                renderHeroList();

                // Featured Cats
                if(featCatDoc.exists) featuredCats = featCatDoc.data().categoryIds || [];
                renderFeaturedCats();

                // Category Sections
                const savedSections = sectionsDoc.exists ? sectionsDoc.data().sections : [];
                categorySections = allCategories.map(cat => {
                    const saved = savedSections.find(s => s.categoryId === cat.id);
                    return {
                        categoryId: cat.id,
                        name: cat.name,
                        visible: saved ? saved.visible : true,
                        order: saved ? saved.order : 9999
                    };
                }).sort((a, b) => a.order - b.order);
                renderCategorySections();

                // Promo Banner
                if(promoDoc.exists) {
                    const data = promoDoc.data();
                    document.getElementById('promo-active').checked = data.active;
                    document.getElementById('promo-text').value = data.text;
                    document.getElementById('promo-link').value = data.link || '';
                }

                // Best Sellers
                if(bestDoc.exists) bestSellersIds = (bestDoc.data().products || []).map(p => p.id);
                document.getElementById('selected-bs-count').textContent = `${bestSellersIds.length} products selected`;

            } catch(e) {
                console.error(e);
                showToast('Error loading data', 'error');
            }
        }

        // --- Logic ---

        // Branding
        function updateColor(hex) {
            document.getElementById('primary-color').value = hex;
            document.getElementById('color-hex').value = hex;
            document.getElementById('color-preview').style.backgroundColor = hex;
        }
        document.getElementById('logo-upload').addEventListener('change', e => {
            const file = e.target.files[0];
            if(file) {
                logoFile = file;
                document.getElementById('logo-preview').src = URL.createObjectURL(file);
                document.getElementById('logo-upload-box').classList.add('has-image');
            }
        });

        // Navigation
        function renderNavigation() {
            const list = document.getElementById('nav-list');
            list.innerHTML = navigation.map((link, i) => `
                <div class="sortable-item">
                    <div class="item-content">
                        <div>
                            <div style="font-weight:600;">${link.label}</div>
                            <div style="font-size:0.85rem; color:var(--text-secondary);">${link.url}</div>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn-icon" onclick="moveNav(${i}, -1)"><i class='bx bx-chevron-up'></i></button>
                        <button class="btn-icon" onclick="moveNav(${i}, 1)"><i class='bx bx-chevron-down'></i></button>
                        <button class="btn-icon" onclick="deleteNav(${i})" style="color:var(--danger-color);"><i class='bx bx-trash'></i></button>
                    </div>
                </div>
            `).join('');
        }
        function addNavLink() {
            const label = document.getElementById('link-label').value;
            const url = document.getElementById('link-url').value;
            if(!label || !url) return showToast('Fields required', 'error');
            navigation.push({label, url});
            renderNavigation();
            closeModal('link-modal');
        }
        function moveNav(i, dir) {
            if (i + dir < 0 || i + dir >= navigation.length) return;
            [navigation[i], navigation[i+dir]] = [navigation[i+dir], navigation[i]];
            renderNavigation();
        }
        function deleteNav(i) { navigation.splice(i, 1); renderNavigation(); }

        // Hero
        document.getElementById('hero-desktop-file').addEventListener('change', e => {
            tempHeroDesktop = e.target.files[0];
            if(tempHeroDesktop) {
                document.getElementById('hero-desktop-preview').src = URL.createObjectURL(tempHeroDesktop);
                document.getElementById('hero-desktop-box').classList.add('has-image');
            }
        });
        document.getElementById('hero-mobile-file').addEventListener('change', e => {
            tempHeroMobile = e.target.files[0];
            if(tempHeroMobile) {
                document.getElementById('hero-mobile-preview').src = URL.createObjectURL(tempHeroMobile);
                document.getElementById('hero-mobile-box').classList.add('has-image');
            }
        });

        async function addHeroImage() {
            if(!tempHeroDesktop) return showToast('Desktop image required', 'error');
            
            const btn = document.querySelector('#hero-modal .btn-primary');
            const prevText = btn.textContent;
            btn.textContent = 'Uploading...'; btn.disabled = true;

            try {
                const dSnapshot = await storage.ref(`hero/${Date.now()}_d_${tempHeroDesktop.name}`).put(tempHeroDesktop);
                const dUrl = await dSnapshot.ref.getDownloadURL();
                
                let mUrl = dUrl;
                if(tempHeroMobile) {
                    const mSnapshot = await storage.ref(`hero/${Date.now()}_m_${tempHeroMobile.name}`).put(tempHeroMobile);
                    mUrl = await mSnapshot.ref.getDownloadURL();
                }

                const link = document.getElementById('hero-link').value;
                heroImages.push({ desktop: dUrl, mobile: mUrl, link });
                renderHeroList();
                closeModal('hero-modal');
            } catch(e) {
                showToast('Upload failed', 'error');
            } finally {
                btn.textContent = prevText; btn.disabled = false;
            }
        }

        function renderHeroList() {
            const list = document.getElementById('hero-list');
            list.innerHTML = heroImages.map((img, i) => `
                <div class="sortable-item">
                    <div class="item-content">
                        <img src="${img.desktop}" style="width:60px; height:40px; object-fit:cover; border-radius:4px;">
                        <div style="font-size:0.9rem; font-weight:500;">Slide ${i+1}</div>
                    </div>
                    <div class="item-actions">
                        <button class="btn-icon" onclick="moveHero(${i}, -1)"><i class='bx bx-chevron-up'></i></button>
                        <button class="btn-icon" onclick="moveHero(${i}, 1)"><i class='bx bx-chevron-down'></i></button>
                        <button class="btn-icon" onclick="deleteHero(${i})" style="color:var(--danger-color);"><i class='bx bx-trash'></i></button>
                    </div>
                </div>
            `).join('');
        }
        function moveHero(i, dir) {
            if (i + dir < 0 || i + dir >= heroImages.length) return;
            [heroImages[i], heroImages[i+dir]] = [heroImages[i+dir], heroImages[i]];
            renderHeroList();
        }
        function deleteHero(i) { heroImages.splice(i, 1); renderHeroList(); }

        // Featured Cats
        function renderFeaturedCats() {
            const list = document.getElementById('featured-cats-list');
            list.innerHTML = allCategories.map(cat => `
                <label style="display:flex; align-items:center; gap:0.5rem; padding:0.5rem; background:white; border:1px solid var(--border-color); border-radius:6px; cursor:pointer;">
                    <input type="checkbox" onchange="toggleFeatured('${cat.id}')" ${featuredCats.includes(cat.id) ? 'checked' : ''}>
                    <span style="font-size:0.9rem;">${cat.name}</span>
                </label>
            `).join('');
        }
        function toggleFeatured(id) {
            if(featuredCats.includes(id)) featuredCats = featuredCats.filter(c => c !== id);
            else featuredCats.push(id);
        }

        // Sections
        function renderCategorySections() {
            const list = document.getElementById('section-list');
            list.innerHTML = categorySections.map((sec, i) => `
                <div class="sortable-item">
                    <div class="item-content">
                        <div style="font-weight:600;">${sec.name}</div>
                    </div>
                    <div class="item-actions" style="align-items:center;">
                        <input type="checkbox" class="toggle-switch" ${sec.visible ? 'checked' : ''} onchange="toggleSection(${i})">
                        <div style="width:10px;"></div>
                        <button class="btn-icon" onclick="moveSection(${i}, -1)"><i class='bx bx-chevron-up'></i></button>
                        <button class="btn-icon" onclick="moveSection(${i}, 1)"><i class='bx bx-chevron-down'></i></button>
                    </div>
                </div>
            `).join('');
        }
        function toggleSection(i) { categorySections[i].visible = !categorySections[i].visible; }
        function moveSection(i, dir) {
            if (i + dir < 0 || i + dir >= categorySections.length) return;
            [categorySections[i], categorySections[i+dir]] = [categorySections[i+dir], categorySections[i]];
            renderCategorySections();
        }

        // Best Sellers
        function openBestSellerModal() {
            document.getElementById('bestseller-modal').style.display = 'flex';
            renderBSList();
        }
        function renderBSList(search = '') {
            const list = document.getElementById('bs-list');
            const filtered = allProducts.filter(p => p.name.toLowerCase().includes(search.toLowerCase()));
            
            if(filtered.length === 0) {
                list.innerHTML = `<div style="padding:2rem; text-align:center; color:#94A3B8;">No products found</div>`;
                return;
            }

            list.innerHTML = filtered.map(p => `
                <div class="product-select-item" onclick="toggleBS('${p.id}')">
                    <div class="product-select-info">
                        <img src="${p.image || 'https://via.placeholder.com/40'}" class="product-select-img">
                        <div>
                            <div style="font-weight:500; font-size:0.9rem;">${p.name}</div>
                            <div style="font-size:0.8rem; color:#64748B;">${p.category}</div>
                        </div>
                    </div>
                    <input type="checkbox" ${bestSellersIds.includes(p.id) ? 'checked' : ''} style="pointer-events:none;">
                </div>
            `).join('');
        }
        function toggleBS(id) {
            if(bestSellersIds.includes(id)) bestSellersIds = bestSellersIds.filter(i => i !== id);
            else bestSellersIds.push(id);
            
            renderBSList(document.getElementById('bs-search').value);
            document.getElementById('selected-bs-count').textContent = `${bestSellersIds.length} products selected`;
        }
        document.getElementById('bs-search').addEventListener('input', e => renderBSList(e.target.value));

        // --- Modals ---
        function openLinkModal() { document.getElementById('link-modal').style.display = 'flex'; document.getElementById('link-label').value=''; document.getElementById('link-url').value=''; }
        function openHeroModal() { 
            document.getElementById('hero-modal').style.display = 'flex'; 
            document.getElementById('hero-desktop-box').classList.remove('has-image');
            document.getElementById('hero-mobile-box').classList.remove('has-image');
            document.getElementById('hero-desktop-file').value = '';
            document.getElementById('hero-mobile-file').value = '';
            tempHeroDesktop = null; tempHeroMobile = null;
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // --- Save ---
        async function saveAllChanges() {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';

            try {
                if(logoFile) {
                    const ref = storage.ref().child(`branding/${Date.now()}-logo`);
                    await ref.put(logoFile);
                    branding.logo = await ref.getDownloadURL();
                }
                
                branding.name = document.getElementById('store-name').value;
                branding.color = document.getElementById('primary-color').value;

                const promoData = {
                    active: document.getElementById('promo-active').checked,
                    text: document.getElementById('promo-text').value,
                    link: document.getElementById('promo-link').value
                };

                const bestSellersObjs = bestSellersIds.map(id => allProducts.find(p => p.id === id)).filter(Boolean);

                await Promise.all([
                    db.collection('landingPage').doc('branding').set(branding),
                    db.collection('landingPage').doc('navigation').set({ links: navigation }),
                    db.collection('landingPage').doc('heroImages').set({ images: heroImages }),
                    db.collection('landingPage').doc('featuredCategories').set({ categoryIds: featuredCats }),
                    db.collection('landingPage').doc('categorySections').set({ sections: categorySections.map((s, idx) => ({ categoryId: s.categoryId, visible: s.visible, order: idx })) }),
                    db.collection('landingPage').doc('promoBanner').set(promoData),
                    db.collection('landingPage').doc('bestSellers').set({ products: bestSellersObjs })
                ]);

                showToast('Site updated successfully!', 'success');

            } catch(e) {
                console.error(e);
                showToast('Save failed', 'error');
            } finally {
                overlay.style.display = 'none';
            }
        }

        function showToast(msg, type='success') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            el.innerHTML = `<i class='bx ${type==='success'?'bx-check-circle':'bx-error-circle'}'></i> <span>${msg}</span>`;
            container.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }
    </script>
</body>
</html>
